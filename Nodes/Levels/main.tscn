[gd_scene load_steps=12 format=3 uid="uid://1ss6vrwe7fqk"]

[ext_resource type="PackedScene" uid="uid://v1b207tjtxd7" path="res://Nodes/Props/plank_floor.tscn" id="1_dp2i7"]
[ext_resource type="Texture2D" uid="uid://dtjiixionvm3u" path="res://Graphics/Textures/noiseTexture.png" id="1_ndwl0"]
[ext_resource type="Texture2D" uid="uid://cpftchpptesj7" path="res://Graphics/Textures/tilingvoronoi.png" id="2_s7x6b"]
[ext_resource type="PackedScene" uid="uid://ds8i0tw3it73m" path="res://Nodes/Props/candle.tscn" id="4_04vmm"]
[ext_resource type="PackedScene" uid="uid://biwcjtqln5q08" path="res://Nodes/Props/spider_web.tscn" id="5_2pygc"]

[sub_resource type="Shader" id="Shader_2gbhu"]
code = "
// NOTE: Shader automatically converted from Godot Engine 4.3.stable.mono's ProceduralSkyMaterial.

shader_type sky;
render_mode use_debanding;

uniform vec4 sky_top_color : source_color = vec4(0.385, 0.454, 0.55, 1.0);
uniform vec4 sky_horizon_color : source_color = vec4(0.646, 0.656, 0.67, 1.0);
uniform float sky_curve : hint_range(0, 1) = 0.15;
uniform float sky_energy = 1.0; // In Lux.
uniform sampler2D sky_cover : filter_linear, source_color, hint_default_black;
uniform vec4 sky_cover_modulate : source_color = vec4(1.0, 1.0, 1.0, 1.0);
uniform vec4 ground_bottom_color : source_color = vec4(0.2, 0.169, 0.133, 1.0);
uniform vec4 ground_horizon_color : source_color = vec4(0.646, 0.656, 0.67, 1.0);
uniform float ground_curve : hint_range(0, 1) = 0.02;
uniform float ground_energy = 1.0;
uniform float sun_angle_max = 30.0;
uniform float sun_curve : hint_range(0, 1) = 0.15;
uniform float exposure : hint_range(0, 128) = 1.0;

uniform sampler2D voronoi_texture;
uniform sampler2D perlin_texture;

uniform float perlin_min;
uniform float perlin_max;
uniform float perlin_cutout;

float map(float value, float srcMin, float srcMax, float destMin, float destMax){
    return destMin + (value-srcMin) * (destMax-destMin) / (srcMax-srcMin);
}

mat3 rotation3dY(float angle) {
  float s = sin(angle);
  float c = cos(angle);
  return mat3(
    vec3(c, 0.0, -s),
    vec3(0.0, 1.0, 0.0),
    vec3(s, 0.0, c)
  );
}

vec4 projImage(float _altitude, float _rot_x, float _viewVec_x, float _imageSize, sampler2D _image) {
	_imageSize = _imageSize / 2.;
    if(_rot_x > _altitude-_imageSize && _rot_x < _altitude+_imageSize){
  	  float xSizeFactor = 2.*PI;
  	  if(_viewVec_x > -_imageSize*xSizeFactor && _viewVec_x < _imageSize*xSizeFactor){
  		  float v = map(_rot_x-_altitude, -_imageSize, _imageSize, 1., 0.);
  		  float u = map(_viewVec_x, -_imageSize*xSizeFactor, _imageSize*xSizeFactor, 0., 1.);
		  return vec4(u,v,0,0);
  		  return texture(_image, vec2(u, v));
  	  }
    }
    return vec4(0);
}

vec4 skyImageProj(vec3 viewVec, float _rotation, float _altitude, float _imageSize, sampler2D _imageSampler) {
    _altitude = fract(_altitude);
    vec3 _EYEDIR = rotation3dY(_rotation) * viewVec;
    //Since we applied the rotation directly to the viewVec we can just ingore it from now on.
 
    //float rot_z = atan(_EYEDIR.y, _EYEDIR.x)/(2.0*PI)+0.5;
    float rot_x = atan(_EYEDIR.y, _EYEDIR.z)/(2.0*PI)+0.5;
    //float rot_y = atan(_EYEDIR.z, _EYEDIR.x)/(2.0*PI)+0.5;
 
    vec4 result = projImage(_altitude, rot_x, _EYEDIR.x, _imageSize, _imageSampler);
 
    //make sure the image isn't clipped when altitude approaches the max/min values
    if(_altitude > 0.75) {
  	  result = max(result, projImage(_altitude-1.0, rot_x, _EYEDIR.x, _imageSize, _imageSampler));
    } else if (_altitude < 0.25) {
  	  result = max(result, projImage(_altitude+1.0, rot_x, _EYEDIR.x, _imageSize, _imageSampler));
    }
    return result;
}

vec2 calculate_pitch_yaw(vec3 direction) {
	// Yaw is the bearing of the forward vector's shadow in the xy plane.
    float yaw = atan(direction.x / direction.z);

    // Pitch is the altitude of the forward vector off the xy plane, toward the down direction.
    float pitch = asin(direction.y)/PI;
	
	return vec2(pitch, yaw);
}

vec3 calculate_light_disk(vec3 light_color, float light_energy, vec3 light_dir, vec3 eye_dir) {
	vec2 pitch_yaw = calculate_pitch_yaw(-light_dir);
	//return skyImageProj(eye_dir, -pitch_yaw.y, pitch_yaw.x, sun_angle_max, perlin_texture).xyz;
	
	return light_color * light_energy * 30.;
}

vec3 calculate_sky_from_light(vec3 sky, vec3 eye_dir, vec3 light_dir, float light_size, float light_energy, vec3 light_color, vec2 sky_coords) {
	//return calculate_light_disk(
		//light_color, light_energy, light_dir, eye_dir
	//);
	float sun_angle = acos(dot(light_dir, eye_dir));
	if (sun_angle < light_size) {
		return calculate_light_disk(
			light_color, light_energy, light_dir, eye_dir
		);
	} else if (sun_angle < sun_angle_max) {
		float c2 = (sun_angle - light_size) / (sun_angle_max - light_size);
		return mix(
			calculate_light_disk(
				light_color, light_energy, light_dir, eye_dir
			),
			sky,
			clamp(1.0 - pow(1.0 - c2, 1.0 / sun_curve), 0.0, 1.0)
		);
	}
	return sky;
}

void sky() {
	float v_angle = acos(clamp(EYEDIR.y, -1.0, 1.0));
	float c = (1.0 - v_angle / (PI * 0.5));
	float sky_gradient = clamp(1.0 - pow(1.0 - c, 1.0 / sky_curve), 0.0, 1.0);
	vec3 sky = mix(sky_horizon_color.rgb, sky_top_color.rgb, sky_gradient);
	sky *= sky_energy;

	if (LIGHT0_ENABLED) {
		sky = calculate_sky_from_light(sky, EYEDIR, LIGHT0_DIRECTION, LIGHT0_SIZE, LIGHT0_ENERGY, LIGHT0_COLOR, SKY_COORDS);
	}

	if (LIGHT1_ENABLED) {
		sky = calculate_sky_from_light(sky, EYEDIR, LIGHT1_DIRECTION, LIGHT1_SIZE, LIGHT1_ENERGY, LIGHT1_COLOR, SKY_COORDS);
	}

	if (LIGHT2_ENABLED) {
		sky = calculate_sky_from_light(sky, EYEDIR, LIGHT2_DIRECTION, LIGHT2_SIZE, LIGHT2_ENERGY, LIGHT2_COLOR, SKY_COORDS);
	}

	if (LIGHT3_ENABLED) {
		sky = calculate_sky_from_light(sky, EYEDIR, LIGHT3_DIRECTION, LIGHT3_SIZE, LIGHT3_ENERGY, LIGHT3_COLOR, SKY_COORDS);
	}

	vec4 sky_cover_texture = texture(sky_cover, SKY_COORDS);
	sky += (sky_cover_texture.rgb * sky_cover_modulate.rgb) * sky_cover_texture.a * sky_cover_modulate.a * sky_energy;

	c = (v_angle - (PI * 0.5)) / (PI * 0.5);
	vec3 ground = mix(ground_horizon_color.rgb, ground_bottom_color.rgb, clamp(1.0 - pow(1.0 - c, 1.0 / ground_curve), 0.0, 1.0));
	ground *= ground_energy;

	
	float perlin_range = perlin_max - perlin_min;
	float perlin = perlin_min + clamp(texture(perlin_texture, SKY_COORDS*vec2(2)).x - perlin_cutout, 0, 1) * perlin_range;
	COLOR = mix(
		ground,
		sky + clamp(mix(
			vec3(0),
			smoothstep(
				.35,
				.36,
				clamp(texture(voronoi_texture, SKY_COORDS*vec2(15)).xyz, 0, 1)
			) * perlin + clamp(pow(((texture(perlin_texture, SKY_COORDS).x) + .5f) * .62, 12), 0, 1) * vec3(.6, .3, .9),
			sky_gradient-.6
		), 0, 1),
		step(0.0, EYEDIR.y)
	) * exposure;
	//COLOR = sky;
	//COLOR = vec3(abs(calculate_pitch_yaw(EYEDIR)) / PI * 2.,0);
}
"

[sub_resource type="ShaderMaterial" id="ShaderMaterial_ipld8"]
shader = SubResource("Shader_2gbhu")
shader_parameter/sky_top_color = Color(0.0155834, 0.0394169, 0.0679986, 1)
shader_parameter/sky_horizon_color = Color(0.0849764, 0.0471689, 0.0416048, 1)
shader_parameter/sky_curve = 0.096
shader_parameter/sky_energy = 1.0
shader_parameter/sky_cover_modulate = Color(1, 1, 1, 1)
shader_parameter/ground_bottom_color = Color(0, 0, 0, 1)
shader_parameter/ground_horizon_color = Color(0.102597, 0.049701, 0.0281515, 1)
shader_parameter/ground_curve = 0.02
shader_parameter/ground_energy = 1.0
shader_parameter/sun_angle_max = 0.04
shader_parameter/sun_curve = 1.0
shader_parameter/exposure = 3.7
shader_parameter/perlin_min = 0.0
shader_parameter/perlin_max = 1.0
shader_parameter/perlin_cutout = 0.465
shader_parameter/voronoi_texture = ExtResource("2_s7x6b")
shader_parameter/perlin_texture = ExtResource("1_ndwl0")

[sub_resource type="Sky" id="Sky_f737e"]
sky_material = SubResource("ShaderMaterial_ipld8")

[sub_resource type="Environment" id="Environment_3w1yn"]
background_mode = 2
sky = SubResource("Sky_f737e")
tonemap_mode = 3
tonemap_exposure = 2.0
glow_enabled = true
volumetric_fog_enabled = true
volumetric_fog_density = 0.018

[sub_resource type="SphereMesh" id="SphereMesh_igkbj"]

[sub_resource type="SphereShape3D" id="SphereShape3D_p0rhh"]

[node name="Main" type="Node3D"]

[node name="Config" type="Node" parent="."]

[node name="WorldEnvironment" type="WorldEnvironment" parent="Config"]
environment = SubResource("Environment_3w1yn")

[node name="DirectionalLight3D" type="DirectionalLight3D" parent="Config"]
transform = Transform3D(-0.878817, 0.0639327, -0.472856, 0, 0.990983, 0.133986, 0.477159, 0.117749, -0.870893, 0, 0, 0)
light_color = Color(0.73, 0.901, 1, 1)
light_energy = 0.05
shadow_enabled = true

[node name="Camera3D" type="Camera3D" parent="Config"]
transform = Transform3D(1, 0, 0, 0, 0.991945, 0.126666, 0, -0.126666, 0.991945, 0, 3.66136, 11.9677)

[node name="Environment" type="Node" parent="."]

[node name="Floor" type="Node" parent="Environment"]

[node name="Node3D" parent="Environment/Floor" instance=ExtResource("1_dp2i7")]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0.152148, 0, -0.305392)

[node name="Node3D7" parent="Environment/Floor" instance=ExtResource("1_dp2i7")]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -4.80017, 0, -0.305392)

[node name="Node3D8" parent="Environment/Floor" instance=ExtResource("1_dp2i7")]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -4.80017, 0, -6.45299)

[node name="Node3D9" parent="Environment/Floor" instance=ExtResource("1_dp2i7")]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -4.80017, 0, 5.83676)

[node name="Node3D5" parent="Environment/Floor" instance=ExtResource("1_dp2i7")]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0.152148, 0, -6.3819)

[node name="Node3D6" parent="Environment/Floor" instance=ExtResource("1_dp2i7")]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 5.07421, 0, -6.40284)

[node name="Node3D3" parent="Environment/Floor" instance=ExtResource("1_dp2i7")]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 5.10774, 0, -0.305392)

[node name="Node3D4" parent="Environment/Floor" instance=ExtResource("1_dp2i7")]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 5.10774, 0, 5.83894)

[node name="Node3D2" parent="Environment/Floor" instance=ExtResource("1_dp2i7")]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0.152148, 0, 5.86603)

[node name="Light" type="Node" parent="Environment"]

[node name="Candle" parent="Environment/Light" instance=ExtResource("4_04vmm")]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 1.19845, 0.173521, -1.62441)

[node name="Candle2" parent="Environment/Light" instance=ExtResource("4_04vmm")]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 3.54011, 0.411573, 1.29932)

[node name="Candle3" parent="Environment/Light" instance=ExtResource("4_04vmm")]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 2.33729, 0.227706, 3.81467)

[node name="Candle4" parent="Environment/Light" instance=ExtResource("4_04vmm")]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -1.48289, 0.173522, 0.331644)

[node name="Candle5" parent="Environment/Light" instance=ExtResource("4_04vmm")]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0.788067, 0.173522, 1.45709)

[node name="Candle6" parent="Environment/Light" instance=ExtResource("4_04vmm")]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -0.866857, 0.119582, 3.42913)

[node name="SpiderWeb" parent="Environment/Light" instance=ExtResource("5_2pygc")]
transform = Transform3D(-0.381921, 0.601672, -1.96918, -1.47316, 0.626072, 1.43028, 2.32272, 0.49601, 0.583345, -4.25346, 3.31653, -6.08165)

[node name="PhysicalBall" type="RigidBody3D" parent="."]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 5.31071, 0)

[node name="MeshInstance3D" type="MeshInstance3D" parent="PhysicalBall"]
mesh = SubResource("SphereMesh_igkbj")

[node name="CollisionShape3D" type="CollisionShape3D" parent="PhysicalBall"]
shape = SubResource("SphereShape3D_p0rhh")
